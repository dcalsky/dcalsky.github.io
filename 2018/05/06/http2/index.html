<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="周左左个人博客"><title>HTTP2特性漫谈 | 白玉为堂金为马</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HTTP2特性漫谈</h1><a id="logo" href="/.">白玉为堂金为马</a><p class="description">70%有趣的灵魂</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">HTTP2特性漫谈</h1><div class="post-meta">May 6, 2018<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span></div><div class="post-content"><p>在2018年春招中，没有回答出HTTP2新特性的具体细节，甚是懊恼。看来不能仅仅因为兼容性的问题，就不顾HTTP2这票潜力股😈。</p>
<a id="more"></a>
<p>首先概况几个HTTP2相对于HTTP1.1的<strong>新特性</strong>:</p>
<ul>
<li>二进制分帧层</li>
<li>头部压缩</li>
<li>多路复用</li>
<li>Server Push</li>
</ul>
<h2 id="为什么不是HTTP-1-2"><a href="#为什么不是HTTP-1-2" class="headerlink" title="为什么不是HTTP/1.2?"></a>为什么不是HTTP/1.2?</h2><p>为了实现 HTTP 工作组设定的性能目标，HTTP/2 引入了一个新的二进制分帧层，该层无法与之前的 HTTP/1.x 服务器和客户端向后兼容，因此协议的主版本提升到 HTTP/2。</p>
<h2 id="二进制分帧层"><a href="#二进制分帧层" class="headerlink" title="二进制分帧层"></a>二进制分帧层</h2><p>HTTP/2 所有性能增强的核心在于新的二进制分帧层，它定义了如何封装 HTTP 消息并在客户端与服务器之间传输。如下图所示，它在应用层里，多定义了一个新的子层：<br><img src="https://developers.google.com/web/fundamentals/performance/http2/images/binary_framing_layer01.svg" alt=""></p>
<p>而HTTP的语义（包括各种动词、方法、标头）都不受影响，不同的是传输期间对它们的编码方式变了。HTTP/1.x 协议以换行符作为纯文本的分隔符，而 HTTP/2 将所有传输的信息分割为更小的消息和帧，并采用二进制格式对它们编码。<strong>但是</strong>！HTTP/1.x 客户端无法理解只支持 HTTP/2 的服务器，反之亦然。</p>
<h3 id="数据流、消息和帧"><a href="#数据流、消息和帧" class="headerlink" title="数据流、消息和帧"></a>数据流、消息和帧</h3><ul>
<li>数据流：已建立的连接内的双向字节流，可以承载一条或多条消息。stream</li>
<li>消息：与逻辑请求或响应消息对应的完整的一系列帧。message</li>
<li>帧：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流。frame</li>
</ul>
<p>他们遵循以下的规则:</p>
<ol>
<li>所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。</li>
<li>每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。</li>
<li>每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧。</li>
<li>帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载，等等。 <strong>来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。</strong></li>
</ol>
<p>所以大致的示意图是:<br><img src="https://developers.google.com/web/fundamentals/performance/http2/images/streams_messages_frames01.svg" alt=""></p>
<p>简言之，HTTP/2 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。所有这些都在一个 TCP 连接内复用。这是 HTTP/2 协议所有其他功能和性能优化的基础。</p>
<h2 id="头部压缩"><a href="#头部压缩" class="headerlink" title="头部压缩"></a>头部压缩</h2><p>HTTP头是比较长的，如果发送的数据比较小时，也得发送一个很大的HTTP头部。当这种请求数很多的时候，会导致网络的吞吐率不高。并且，比较大的HTTP头部会迅速占满<strong>慢启动</strong>过程中的<strong>拥塞窗口</strong>，导致延迟加大。所以HTTP头的压缩显得很有必要。</p>
<p>HTTP/2使用了新的压缩方法，在规范<a href="https://tools.ietf.org/html/rfc7541" target="_blank" rel="noopener">RFC 7541</a>进行了说明。关于头部压缩，规范的附录举了个很生动的例子。这里用这个例子做为说明，解释可以怎么对HTTP头部进行压缩。</p>
<h2 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h2><p>传统的HTTP/1.1为了提高并发性，得通过提高连接数，即同时多发几个请求，因为一个连接只能发一个请求，所以需要多建立几个TCP连接。建立TCP连接需要线程开销，Chrome同一个域最多同时只能建立<strong>6个连接</strong>(考点哟)。所以就有了雪碧图、合并代码文件等减少请求数的解决方案。</p>
<p>在HTTP/2里面，一个域只需要建立一次TCP连接就可以传输多个资源。多个数据流/信号通过一条信道进行传输，充分地利用高速信道，就叫多路复用（Multiplexing）。</p>
<p>在HTTP/1.1里面，一个资源通过一个TCP连接传输，一个大的资源可能会被拆成多个TCP报文段，每个报文段都有它的编号，按照从前往后依次增大的顺序，接收方把收到的报文段按照顺序依次拼接，就得到了完整的资源。当然，这个是TCP传输自然的特性，其实和HTTP/1.1没有直接关系。</p>
<p>那么怎么用一个连接传输多个资源呢？HTTP/2把每一个资源的传输叫做流(Stream)，每个流都有它的唯一编号stream id，一个流又可能被拆成多个帧(Frame)，每个帧按照顺序发送，TCP报文的编号可以保证后发送的帧的顺序比先发送的大。在HTTP/1.1里面同一个资源顺序是依次连续增大的，因为只有一个资源，而在HTTP/2里面它很可能是离散变大的，中间会插着发送其它流的帧，但只要保证每个流按顺序拼接就好了。如下图所示：<br><img src="http://static.noddl.me/15213774079923.jpg" alt=""></p>
<h2 id="Server-Push"><a href="#Server-Push" class="headerlink" title="Server Push"></a>Server Push</h2><p>当我们使用HTTP/1.1的时候，Chrome最多同时加载6个资源。</p>
<p>虽然使用了HTTP/2没有了只能同时加载6个资源的限制，但是我们发现css或js需要在html解析了之后才能触发加载，而图片如果是通过JS的new Image触发加载，所以它们需要等到JS下载完并解析好了才能开始加载。</p>
<p>所以Server Push就是为了解决这个加载延迟问题，提前把网页需要的资源Push给浏览器。Nginx是从1.13.9版本开始支持。给nginx.conf添加以下配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> = /html/demo/index.html &#123;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/main.js;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/main.css;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">0</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">1</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">2</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">3</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">4</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">5</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">6</span>.png;</span><br><span class="line">    <span class="attribute">http2_push</span> /html/demo/images/<span class="number">7</span>.png;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此一来就可以享受预加载带来的页面加载速度上的提升了。</p>
<p>参考资料:</p>
<ul>
<li><a href="https://fed.renren.com/2018/03/18/chrome-http2/" target="_blank" rel="noopener">https://fed.renren.com/2018/03/18/chrome-http2/</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/http2" target="_blank" rel="noopener">https://developers.google.com/web/fundamentals/performance/http2</a></li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/05/06/offer-gf/">接offer这件事</a><a class="next" href="/2018/05/06/307-sport/">307寝室敏捷运动宣言</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/摄影/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.zhihu.com/people/dcalsky" title="知乎" target="_blank">知乎</a><ul></ul><a href="https://github.com/dcalsky" title="Github" target="_blank">Github</a><ul></ul><a href="mailto:dcalsky@gmail.com" title="电子邮箱" target="_blank">电子邮箱</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">白玉为堂金为马.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>