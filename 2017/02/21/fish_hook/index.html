<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="周左左个人博客"><meta name="theme-color" content="#C6FF00"><title>webhook革命 使用fish-hook自动部署多个应用 | 白玉为堂金为马</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">webhook革命 使用fish-hook自动部署多个应用</h1><a id="logo" href="/.">白玉为堂金为马</a><p class="description">70%有趣的灵魂</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">webhook革命 使用fish-hook自动部署多个应用</h1><div class="post-meta">Feb 21, 2017<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span></div><div class="post-content"><p>一站式高效管理你多个github webhook.<br>Github地址: <a href="https://github.com/dcalsky/fish-hook" target="_blank" rel="noopener">https://github.com/dcalsky/fish-hook</a><br><a id="more"></a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>等你辛苦建立好了静态博客，却依然要忍受每次本地更新后，<strong>还要ssh到远程重新git pull一遍的痛苦。</strong></p>
<p>当你终于用webhook handler写了一堆代码来解决这个应用的部署问题后，你依然发现，还有许许多多的项目等着你为它们写部署代码。</p>
<p>要是有一个集成化的工具，在一个目录里帮我管理所有的webhook就好了！fish-hook就是为此诞生的，它最大的特色就是：极力缩短开发者花在配置上的时间，约定大于配置。</p>
<!-- more -->
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装python3.5或更高版本，再用pip包管理工具安装fish-hook<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install fish-hook</span><br></pre></td></tr></table></figure></p>
<h3 id="新建fish-hook目录"><a href="#新建fish-hook目录" class="headerlink" title="新建fish-hook目录"></a>新建fish-hook目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fish-hook init</span><br></pre></td></tr></table></figure>
<p>ssh进入远程主机后，运行该命令，并且设置一个通用的端口，例如: 2333。这样就创建了名为<code>fish</code>的目录，这是控制所有webhook的总目录。<code>$ cd fish</code>进入该目录。</p>
<h3 id="接收端-为一个仓库创建webhook"><a href="#接收端-为一个仓库创建webhook" class="headerlink" title="接收端: 为一个仓库创建webhook"></a>接收端: 为一个仓库创建webhook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fish-hook new</span><br></pre></td></tr></table></figure>
<p>假如你在github上开通了一个名为<code>blog</code>的仓库，并且打算为其开通webhook来实现自动部署。那么就输入<code>blog</code>以及你要为此webhook设定的密钥。<br>完成后，<code>blog</code>的webhook接收端就部署好了。</p>
<h3 id="发送端-在github上创建webhook"><a href="#发送端-在github上创建webhook" class="headerlink" title="发送端: 在github上创建webhook"></a>发送端: 在github上创建webhook</h3><p>首先打开仓库的github设置页面，然后创建github webhook，填入基本信息。<br>可以注意到<code>Payload URL</code>这一栏，前面的IP地址就是你<code>远程主机的外网IP地址</code>，之后是你刚刚设置的端口，斜杆后就是<code>blog</code>目录，<strong>与接收端的名字相同</strong>。<br>密钥一栏当然也要与在fish-hook上设置的相同。</p>
<p><img src="https://camo.githubusercontent.com/c5d4b2208bc11a1db6afe95ada348a990b4d0c8f/687474703a2f2f7374617469632e6e6f64646c2e6d652f316430313036353332313930393762336166373631636461336461353565356236393862623737652d653734383330336363386563336134343637313137616437663133306565313266383830623465332e706e67" alt="webhook"></p>
<h3 id="设置接受push事件后的动作"><a href="#设置接受push事件后的动作" class="headerlink" title="设置接受push事件后的动作"></a>设置接受push事件后的动作</h3><p>假设你使用<code>git push</code>推送了新的内容到blog仓库，如何执行特定的shell脚本呢？<br>此时的fish-hook目录是这样的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fish/</span><br><span class="line">	config.json</span><br><span class="line">	blog/</span><br><span class="line">		app_config.json</span><br><span class="line">		push.sh</span><br></pre></td></tr></table></figure></p>
<p>为什么有一个push.sh文件呢？就这意味着，当你仓库接受新的push事件后，fish-hook就会运行<code>push.sh</code>这个shell脚本，里面的内容完全可以自己设置。</p>
<p>这就是所谓的<code>约定大于配置</code>，webhook接受到什么样的命令，就会运行<code>相同名字</code>的shell脚本，当然前提是你的目录里要存在这个脚本。</p>
<h3 id="上线"><a href="#上线" class="headerlink" title="上线"></a>上线</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fish-hook server</span><br></pre></td></tr></table></figure>
<p>fish-hook为你封装了部署所需的web server。一条命令即可启动，此时所有的webhook都会被启用。</p>
<h3 id="开启2333端口"><a href="#开启2333端口" class="headerlink" title="开启2333端口"></a>开启2333端口</h3><p>centos默认开启了端口防火墙，如果你使用了一些具备安全组的云主机服务，<strong>也需要开放所有安全组哦。</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo firewall-cmd --zone=public --add-port=2333/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<h2 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h2><h3 id="使用Screen"><a href="#使用Screen" class="headerlink" title="使用Screen"></a>使用Screen</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ screen -d -m fish-hook server</span><br></pre></td></tr></table></figure>
<p>在<code>fish-hook</code>主目录运行该命令，即可使fish-hook server持久运行下去。</p>
<h2 id="webhook-事件们"><a href="#webhook-事件们" class="headerlink" title="webhook 事件们"></a>webhook 事件们</h2><p><a href="https://github.com/dcalsky/fish-hook#events" target="_blank" rel="noopener">events</a></p>
<h2 id="更多帮助"><a href="#更多帮助" class="headerlink" title="更多帮助"></a>更多帮助</h2><p>请查看github仓库<a href="https://github.com/dcalsky/fish-hook" target="_blank" rel="noopener">fish-hook</a></p>
</div><div class="tags"><a href="/tags/github/">github</a><a href="/tags/部署/">部署</a><a href="/tags/python/">python</a><a href="/tags/webhook/">webhook</a></div><div class="post-nav"><a class="pre" href="/2017/02/23/preface/">序</a><a class="next" href="/2017/02/08/django-rest-framework/">Django rest framework 部分最佳实践</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/摄影/">摄影</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.zhihu.com/people/dcalsky" title="知乎" target="_blank">知乎</a><ul></ul><a href="https://github.com/dcalsky" title="Github" target="_blank">Github</a><ul></ul><a href="mailto:dcalsky@gmail.com" title="电子邮箱" target="_blank">电子邮箱</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">白玉为堂金为马.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>